<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>Snake 1.0</title>
	<style type="text/css">
		table {margin:0; overflow:hidden; border-collapse:collapse; }
		td {width:20px; height:20px; border:1px solid #eee; background:#f4f4f4}
		#message{ width: 100%; margin: 0 auto; text-align: center; font-family: "Comic Sans MS"; font-size: 20px; }
		#snakeBox{ overflow: hidden;padding-left: 600px;  margin: 0 auto;padding: 0;  width: 484px; }
		#snakeArea{ }
		.start{ display: block; margin: 10px 0 0 200px;}
		.cover{ background: #000; }
		.food { background: #000;}
	</style>
	<script type="text/javascript" src="jquery-2.1.0.min.js"></script>
	<script type="text/javascript">
		$(function(){
			var width = 20;
			var height = 20;
			var gridElems = multiArray(width,height);//表格元素
			var carrier = multiArray(width,height);//承载对象
			var len = 3; // 初始长度
			var snake = new Array;//设每个节点的坐标
			var directkey = 39;
			var snakeTimer;
			//生成贪吃蛇
			function initSnake(){
				var pointer = randomPointer(len - 1, len - 1, width/2, 0);
				for (var i = 0; i < len; i++) {
					var x = pointer[0] - 1;
					var y = pointer[1];
					snake.push([x, y]);
					carrier[x][y] = "cover";
				};
			}

			//随机生成目标元素
			function randomPointer(startX, startY, endX, endY){
				var startX = startX || 0;
				var startY = startY || 0;
				var endX = endX || width;
				var endY = endY || height;
				var p =[];
				x = Math.floor(Math.random() * (endX - startX)) + startX;
				y = Math.floor(Math.random() * (endY - startY)) + startY;
				if(carrier[x][y]){
					return randomPointer(startX, startY, endX, endY);
				}
				p[0] = x;
				p[1] = y;
				return p;
			}

			//生成表格
			function createTable(){
				var table = document.createElement("table");
				for (var i = 0;  i < height; i++) {
					var tr = document.createElement("tr");
					for (var j = 0; j < width; j++) {
						var td = document.createElement("td");
						gridElems[j][i] = tr.appendChild(td);
					};
					table.appendChild(tr)
				};
				document.getElementById("snakeArea").appendChild(table);
				console.log(gridElems);
			}

			//生成目标
			function addObject(name){
				var p = randomPointer();
				var x = p[0];
				var y = p[1];
				carrier[x][y] = name;
				gridElems[x][y].className = name;
				console.log(p);
			}


			//判断
			function step(){
				//把snake的头位置暂存起来
				var  headX = snake[0][0], headY = snake[0][1];
				switch(directkey){
					case 37: headX -= 1; break; //left
					case 38: headY -= 1; break; //up
					case 39: headX += 1; break; //right
					case 40: headY += 1; break; //down
				}

				if(headX >= width || headX < 0 || headY >= height || headY < 0 || carrier[headX][headY] == "cover" ){
					$("#message").html("Game Over.");
					window.clearInterval(snakeTimer);
					console.log("Game Over.");
					return;
				}

				if(carrier[headX][headY] != "food"){
					var lastX = snake[snake.length - 1][0];
					var lastY = snake[snake.length - 1][1];
					carrier[lastX][lastY] = false;
					gridElems[lastX][lastY].className = "";
					snake.pop();
				} else {
					carrier[headX][headY] = false;
					console.log("迟到食物");
					addObject("food");
				}

				snake.unshift([headX, headY]);
				console.log(snake);
				carrier[headX][headY] = "cover";
				gridElems[headX][headY].className = "cover";
				len = snake.length;
				console.log(len);
			}

			//生成二维数组
			function multiArray(n, m){
				var arr = new Array(n);
				for (var i = 0; i < arr.length; i++) {
					arr[i] = new Array(m);
				};
				return arr
			}
			
			function walk(){
				if(snakeTimer){
					clearInterval(snakeTimer);
				}
				snakeTimer = setInterval(function (){ step(); }, 300);
			}

			$(document).keydown(function(e) {
				e = e || event;
				directkey = Math.abs(e.keyCode - directkey) != 2 && e.keyCode > 36 && e.keyCode < 41 ? e.keyCode : directkey; //非方向键、反向无效
				return false;
			});

			createTable();
			$(".start").click(function(){
				initSnake();
				walk();
				addObject("food");			
			})
		})
	</script>
</head>
<body>
	<div id="message">Reday,GO!!</div>
	<div id="snakeBox">
		<div id="snakeArea"></div>
		<input type="button" value="Start" class="start">
	</div>
</body>
</html>